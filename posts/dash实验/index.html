<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>DASH实验报告 | M1YAN&#39;s Blog</title>
<meta name="keywords" content="大作业, 计算机网络">
<meta name="description" content="DASH系统搭建流程
客户端搭建
首先，用git命令将dash.js下载到本地.
 git clone https://github.com/Dash-Industry-Forum/dash.js.git
在dash.js目录下，编译运行dash.js.">
<meta name="author" content="Mi Yan">
<link rel="canonical" href="https://m1yan.github.io/posts/dash%E5%AE%9E%E9%AA%8C/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.e953d68ecc56e19e6c4b31518bb49363c7b37da956ca156a1a80e33bb0b85795.css" integrity="sha256-6VPWjsxW4Z5sSzFRi7STY8ezfalWyhVqGoDjO7C4V5U=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://m1yan.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://m1yan.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://m1yan.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://m1yan.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://m1yan.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://m1yan.github.io/posts/dash%E5%AE%9E%E9%AA%8C/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/katex.min.css" integrity="sha384-bYdxxUwYipFNohQlHt0bjN/LCpueqWz13HufFEV1SUatKs1cm4L6fFgCi1jT643X" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/katex.min.js" integrity="sha384-Qsn9KnoKISj6dI8g7p1HBlNpVx0I8p1SvlwOldgi3IorMle61nQy4zEahWYtljaz" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          
          
          delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false}
          ],
          
          throwOnError : false
        });
    });
</script>

<link rel="stylesheet" href="https://s1.hdslb.com/bfs/static/jinkela/long/font/regular.css" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap" rel="stylesheet"><meta property="og:url" content="https://m1yan.github.io/posts/dash%E5%AE%9E%E9%AA%8C/">
  <meta property="og:site_name" content="M1YAN&#39;s Blog">
  <meta property="og:title" content="DASH实验报告">
  <meta property="og:description" content="DASH系统搭建流程 客户端搭建 首先，用git命令将dash.js下载到本地.
git clone https://github.com/Dash-Industry-Forum/dash.js.git 在dash.js目录下，编译运行dash.js.">
  <meta property="og:locale" content="zh">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-17T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-04-17T00:00:00+00:00">
    <meta property="article:tag" content="大作业">
    <meta property="article:tag" content="计算机网络">
      <meta property="og:image" content="https://m1yan.github.io/images/papermod-cover.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://m1yan.github.io/images/papermod-cover.png">
<meta name="twitter:title" content="DASH实验报告">
<meta name="twitter:description" content="DASH系统搭建流程
客户端搭建
首先，用git命令将dash.js下载到本地.
 git clone https://github.com/Dash-Industry-Forum/dash.js.git
在dash.js目录下，编译运行dash.js.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://m1yan.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "DASH实验报告",
      "item": "https://m1yan.github.io/posts/dash%E5%AE%9E%E9%AA%8C/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "DASH实验报告",
  "name": "DASH实验报告",
  "description": "DASH系统搭建流程 客户端搭建 首先，用git命令将dash.js下载到本地.\ngit clone https://github.com/Dash-Industry-Forum/dash.js.git 在dash.js目录下，编译运行dash.js.\n",
  "keywords": [
    "大作业", "计算机网络"
  ],
  "articleBody": "DASH系统搭建流程 客户端搭建 首先，用git命令将dash.js下载到本地.\ngit clone https://github.com/Dash-Industry-Forum/dash.js.git 在dash.js目录下，编译运行dash.js.\n{% message color:danger size: “icon:fa-brands fa-npm” title: %} cd dash.js npm install npm run start {% endmessage %}\n编译完成后，会自动在浏览器页面打开dash系统的网页，点击超链接here进入。点击Load按钮，如果可以正常播放演示视频，说明客户端没有问题。\n部署服务器 使用nginx来部署HTTP服务器。由于后续服务器限速等操作在Linux系统中较为方便，将服务器部署在虚拟机上。\n采用的操作系统版本为Ubuntu 22.04.4 LTS。\n可以使用Linux apt直接安装nginx。\nsudo apt-get install nginx (也可以去官网下载安装包进行安装)\n打开/nginx/conf文件夹下的nginx.conf配置文件，将配置文件内容全部替换为下面代码。这里使用8888端口对外提供下载能力。\nuser root; worker_processes 4; events { use epoll; worker_connections 204800; } http { include mime.types; default_type application/octet-stream; sendfile on; tcp_nopush on; keepalive_timeout 65; tcp_nodelay on; gzip on; client_header_buffer_size 4k; server { listen 8888; server_name 127.0.0.1; add_header Access-Control-Allow-Origin *; add_header Access-Control-Allow-Headers X-Requested-With; add_header Access-Control-Allow-Methods GET,POST,OPTIONS; location / { root home/miyan/Videos; //这里填写所要播放的视频存放的绝对路径 autoindex on; } } } 在nginx.conf所在的文件夹右键打开terminal，输入下面命令启动nginx。\nnginx -p . -c ./nginx.conf 如果要关闭nginx，则使用下面命令来结束进程。\npkill -9 nginx (如果操作权限不够，可以使用下面命令后输入系统密码进入root模式)\nsu root 从服务器中获取视频 首先需要关闭浏览器的缓存，保证客户端请求的视频来自服务器。\n在客户端上方地址栏中填写URL，格式为：http://服务器ip:端口号/视频的mpd文件存放在服务器的路径。\n以我的URL为例：\nhttp://192.168.133.128:8888/Video/bbb-manifest-refresh.mpd\n点击Load按钮，即可播放服务器中的视频，Show Options按钮中可以选择视频流的算法，可以通过视频下方的统计图来观察实时的视频缓冲区大小和比特率。\n实现ABR算法 这里我们采用BBA0算法来实现。\nBBA0算法配置 Dash.js的结构如下图所示：\n配置播放器需要进入文件夹dash.js/samples/dash-if-reference-player。文件夹结构如下：\ndashjs_config.json是播放器配置文件 index.html是播放器前端页面 app/main.js是页面控制逻辑实现 app/rules中包括ABR算法 首先在app/rules中添加算法文件ABB0Rule.js，在index.html中引用该文件：\n\u003cscript src=\"app/main.js\"\u003e\u003c/script\u003e \u003cscript src=\"app/rules/DownloadRatioRule.js\"\u003e\u003c/script\u003e \u003cscript src=\"app/rules/ThroughputRule.js\"\u003e\u003c/script\u003e + \u003cscript src=\"app/rules/BBA0Rule.js\"\u003e\u003c/script\u003e 在app/main.js中修改规则：\nif ($scope.customABRRulesSelected) { - $scope.player.addABRCustomRule('qualitySwitchRules', 'DownloadRatioRule', DownloadRatioRule); /* jshint ignore:line */ - $scope.player.addABRCustomRule('qualitySwitchRules', 'ThroughputRule', CustomThroughputRule); /* jshint ignore:line */ + // $scope.player.addABRCustomRule('qualitySwitchRules', 'DownloadRatioRule', DownloadRatioRule); /* jshint ignore:line */ + // $scope.player.addABRCustomRule('qualitySwitchRules', 'ThroughputRule', CustomThroughputRule); /* jshint ignore:line */ + $scope.player.addABRCustomRule('qualitySwitchRules', 'BBA0Rule', CustomBBA0Rule); /* jshint ignore:line */ } else { - $scope.player.removeABRCustomRule('DownloadRatioRule'); - $scope.player.removeABRCustomRule('ThroughputRule'); + // $scope.player.removeABRCustomRule('DownloadRatioRule'); + // $scope.player.removeABRCustomRule('ThroughputRule'); + $scope.player.removeABRCustomRule('BBA0Rule'); } }; 修改配置文件dashjs_config.json来修改buffer大小，使得更适应实验环境。\n{ \"streaming\": { \"buffer\": { \"stableBufferTime\": 24, \"bufferTimeAtTopQuality\": 24, \"bufferTimeAtTopQualityLongForm\": 20 } }, \"debug\": { \"logLevel\": 4 } } Dash协议和ABR算法 在解释BBA0算法原理之前，先来了解一下视频流式传播的原理。\n区别于之前将整个视频缓存到本地再播放的技术，流式传输允许一边下载一边播放。所采取的方法是将视频和音频切割成一小段一小段的视频，每个视频包含几秒钟的内容。客户端会在本地维护一个缓冲区buffer，每次播放到T时刻后，会请求后续[T,T+k]时间段内的视频块，然后保存在本地的buffer里，这样就可以实现边下边播。\n在现实生活中，不同客户端面临的网络状况不同，因此服务器需要准备不同码率的视频块，以根据网络情况，动态调整传输的视频质量。\nDash协议简述 Dash (Dynamic Adaptive Streaming over HTTP)协议是一种自适应动态选择传输码率的传输协议。Dash要求服务器准备不同码率和分辨率的视频切片和MPD文件，视频传输时，首先请求MPD文件并进行解析。之后，客户端会根据网络情况，buffer水平等信息对后续视频码率的请求进行动态调整。下图很好地描述了Dash系统的工作原理。\n其中的MPD文件包含了视频切片列表，以及每个切片的描述信息（包括码率、分辨率等）。文件结构如下图所示：\nABR算法简介 ABR算法（自适应码率调节算法）的目的是让用户有更好的观看视频体验。ABR算法的评价标准为用户体验质量 (QoD, Quality of Experience)，包括高视频质量、低卡顿时间、少质量切换、低启动延迟等。\nBBA0算法 BBA0算法的js实现代码如下：\n/*global dashjs*/ let CustomBBA0Rule; function CustomBBA0RuleClass() { let factory = dashjs.FactoryMaker; let SwitchRequest = factory.getClassFactoryByName('SwitchRequest'); let DashMetrics = factory.getSingletonFactoryByName('DashMetrics'); let Debug = factory.getSingletonFactoryByName('Debug'); let context = this.context; let instance, logger; const reservoir = 5; const cushion = 10; let ratePrev = 0; function setup() { logger = Debug(context).getInstance().getLogger(instance); } function getMaxIndex(rulesContext) { let mediaInfo = rulesContext.getMediaInfo(); let mediaType = mediaInfo.type; if (mediaType != \"video\") { return SwitchRequest(context).create(0); } let abrController = rulesContext.getAbrController(); let dashMetrics = DashMetrics(context).getInstance(); let rateMap = {}; let bitrateList = abrController.getBitrateList(mediaInfo) .map(function(bitrateInfo){ return bitrateInfo.bitrate; }); let bitrateCnt = bitrateList.length; let step = cushion / (bitrateCnt - 1); for (let i = 0; i \u003c bitrateCnt; i++) { rateMap[reservoir + i * step] = bitrateList[i]; } let rateMin = bitrateList[0]; let rateMax = bitrateList[bitrateCnt - 1]; ratePrev = ratePrev \u003e rateMin ? ratePrev : rateMin; let ratePlus = rateMax; let rateMinus = rateMin; if (ratePrev === rateMax) { ratePlus = rateMax; } else { for (let i = 0; i \u003c bitrateCnt; i++) { if (bitrateList[i] \u003e ratePrev) { ratePlus = bitrateList[i]; break; } } } if (ratePrev === rateMin) { rateMinus = rateMin; } else { for (let i = bitrateCnt - 1; i \u003e= 0; i--) { if (bitrateList[i] \u003c ratePrev) { rateMinus = bitrateList[i]; break; } } } let currentBufferLevel = dashMetrics.getCurrentBufferLevel(mediaType, true); let func = function(bufferLevel) { if (bufferLevel \u003c reservoir) { return rateMap[cushion + reservoir]; } else if (bufferLevel \u003e cushion + reservoir) { return rateMap[reservoir]; } else { let index = Math.round((bufferLevel - reservoir) / step) *step + reservoir; return rateMap[index]; } }; let fBufferLevel = func(currentBufferLevel); let rateNext; if(currentBufferLevel \u003c= reservoir) { rateNext = rateMin; } else if (currentBufferLevel \u003e= cushion + reservoir) { rateNext = rateMax; } else if (fBufferLevel \u003e= ratePlus) { for (let i = bitrateCnt; i \u003e= 0; i--) { if (bitrateList[i] \u003c= fBufferLevel) { rateNext = bitrateList[i]; break; } } } else if (fBufferLevel \u003c= rateMinus) { for (let i = 0; i \u003c bitrateCnt; i++) { if (bitrateList[i] \u003e fBufferLevel) { rateNext = bitrateList[i]; break; } } } else { rateNext = ratePrev; } let quality = 0; for (let i = 0; i \u003c bitrateCnt; i++) { if (bitrateList[i] == rateNext) { quality = i; break; } } logger.info(\"[BBA0Rule] CurrentBufferLevel = \" + currentBufferLevel); logger.info(\"[BBA0Rule] Bitrate list = \" + bitrateList); logger.info(\"[BBA0Rule] Previous bitrate = \" + ratePrev); logger.info(\"[BBA0Rule] Next bitrate = \" + rateNext); logger.info(\"[BBA0Rule] Quality = \" + quality); ratePrev = rateNext; return SwitchRequest(context).create( quality, { name: CustomBBA0RuleClass.__dashjs_factory_name }, SwitchRequest.PRIORITY.STRONG ); } instance = { getMaxIndex: getMaxIndex }; setup(); return instance; } CustomBBA0RuleClass.__dashjs_factory_name = 'CustomBBA0Rule'; CustomBBA0Rule = dashjs.FactoryMaker.getClassFactory(CustomBBA0RuleClass); 这段代码实现了一个自定义的基于缓冲区的自适应比特率调整规则，称为 BBA0Rule。下面是算法的基本原理和解释：\n缓冲区分级：\n规则将缓冲区分为两个区间：reservoir 和 cushion。Reservoir 是一个较小的缓冲区域，cushion 是一个较大的缓冲区域。 如果当前缓冲区低于 reservoir，则会选择最高比特率。 如果当前缓冲区高于 cushion + reservoir，则会选择最低比特率。 在两个区间之间，根据当前缓冲区的位置，线性地分配比特率。 比特率调整：\n如果当前缓冲区低于 reservoir，选择最高比特率。 如果当前缓冲区高于 cushion + reservoir，选择最低比特率。 如果当前缓冲区在两个区间之间，则根据当前缓冲区的位置线性地调整比特率。 计算当前缓冲区在两个区间之间的相对位置： 首先，算法计算当前缓冲区水平相对于 reservoir 的位置，即当前缓冲区水平减去 reservoir。然后，它将这个相对位置除以 cushion 减去 reservoir，得到一个介于 0 到 1 之间的值，表示当前缓冲区在两个区间之间的相对位置。 线性插值： 然后，算法使用这个相对位置来进行线性插值。它将相对位置乘以 bitrateList 中相邻比特率的差异，然后加上 reservoir 对应的比特率。这样就得到了一个介于最小和最大比特率之间的插值比特率，这个插值比特率取决于当前缓冲区的水平。 选择比特率： 最后，根据线性插值得到的比特率，算法将其作为下一个选择的比特率。这个插值比特率在两个区间之间提供了一个平滑的过渡，使得在缓冲区水平变化时，比特率的调整更加连续和平稳。 变量：\nreservoir：较小的缓冲区域大小。 cushion：较大的缓冲区域大小。 ratePrev：上一个选择的比特率。 rateMap：用于存储不同缓冲区水平下的比特率。 实现细节：\n规则通过获取媒体信息、ABR 控制器和 Dash 指标等来执行决策。 通过调整当前缓冲区水平来选择适当的比特率。 记录每次的选择，以便下一次选择时使用。 日志输出：\n在选择比特率时输出相关的日志信息，包括当前缓冲区水平、比特率列表、上一个选择的比特率、下一个选择的比特率和选择的质量等信息。 这种规则的核心思想是根据当前缓冲区的状态来调整比特率，以平衡视频质量和播放的连续性。Buffer水平与视频速率的关系如下图所示。\n限速条件下测试Dash系统 linux系统自带的tc命令可以对网络带宽进行限制。\n首先可以执行下面命令来获取网卡名称：\nifconfig 其中，ens33即为网卡名称，下面的192.168.133.128为主机ip地址。\n执行下面的命令可以为网卡限制带宽：\ntc qdisc add dev ens33 root tbf rate 500Kbit latency 50ms burst 15kb #将eth0网卡限速到500Kbit/s，15bk的buffer，TBF最多产生50ms的延迟 #tbf是Token Bucket Filter的简写，适合于把流速降低到某个值 执行下面命令可以取消限制：\ntc qdisc del dev ens33 root 单一限速条件 无限速条件 可以看到缓冲区大小稳定的上下波动，视频播放为最高质量，说明此时网络较为稳定且网速较快，可以完成“边下边播”的任务。\n限速300kb，15kb buffer，最大50ms延迟 此时网速较慢，视频很卡顿。视频质量和buffer水平都很低。\n限速800kb，15kb buffer，最大50ms延迟 此时视频质量和buffer水平较300kb时均有上升，但视频质量仍然一般。\n模拟网络波动情况 在服务器端运行该python文件，来控制网速不断发生变化。\n#控制带宽随时间变化 import os import json import time tpt = [300,500,700,900,1200,1800,2000,1500,1200,900,700,500,300] while 1: for v in tpt: os.system(\"sudo tc qdisc add dev eth0 root tbf rate {}kbit latency 50ms burst 15kb\".format(v)) print(v) time.sleep(5) os.system(\"sudo tc qdisc del dev eth0 root\") buffer水平和视频码率变化如下图所示：\n可以看出，当buffer水平升高时，会导致视频切换到更高的码率；buffer水平下降时，会让视频切换到更低的码率。同时buffer也在不断的消耗和补充。\n",
  "wordCount" : "3643",
  "inLanguage": "zh",
  "image": "https://m1yan.github.io/images/papermod-cover.png","datePublished": "2024-04-17T00:00:00Z",
  "dateModified": "2024-04-17T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Mi Yan"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://m1yan.github.io/posts/dash%E5%AE%9E%E9%AA%8C/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "M1YAN's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://m1yan.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://m1yan.github.io/" accesskey="h" title="M1YAN&#39;s Blog (Alt + H)">M1YAN&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="https://m1yan.github.io/en/" title="English"
                            aria-label="English">English</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://m1yan.github.io/archives" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="https://m1yan.github.io/search/" title="搜索">
                    <span>搜索</span>
                </a>
            </li>
            <li>
                <a href="https://m1yan.github.io/tags/" title="标签">
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="https://github.com/adityatelange/hugo-PaperMod/wiki/" title="WiKi">
                    <span>WiKi</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://m1yan.github.io/">主页</a>&nbsp;»&nbsp;<a href="https://m1yan.github.io/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      DASH实验报告
    </h1>
    <div class="post-meta"><span title='2024-04-17 00:00:00 +0000 UTC'>四月 17, 2024</span>&nbsp;·&nbsp;8 分钟&nbsp;·&nbsp;Mi Yan&nbsp;|&nbsp;<a href="https://github.com/M1YAN/M1YAN.github.io/tree/main/posts/posts/DASH%e5%ae%9e%e9%aa%8c.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#dash%e7%b3%bb%e7%bb%9f%e6%90%ad%e5%bb%ba%e6%b5%81%e7%a8%8b" aria-label="DASH系统搭建流程">DASH系统搭建流程</a><ul>
                        
                <li>
                    <a href="#%e5%ae%a2%e6%88%b7%e7%ab%af%e6%90%ad%e5%bb%ba" aria-label="客户端搭建">客户端搭建</a></li>
                <li>
                    <a href="#%e9%83%a8%e7%bd%b2%e6%9c%8d%e5%8a%a1%e5%99%a8" aria-label="部署服务器">部署服务器</a></li>
                <li>
                    <a href="#%e4%bb%8e%e6%9c%8d%e5%8a%a1%e5%99%a8%e4%b8%ad%e8%8e%b7%e5%8f%96%e8%a7%86%e9%a2%91" aria-label="从服务器中获取视频">从服务器中获取视频</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0abr%e7%ae%97%e6%b3%95" aria-label="实现ABR算法">实现ABR算法</a><ul>
                        
                <li>
                    <a href="#bba0%e7%ae%97%e6%b3%95%e9%85%8d%e7%bd%ae" aria-label="BBA0算法配置">BBA0算法配置</a></li>
                <li>
                    <a href="#dash%e5%8d%8f%e8%ae%ae%e5%92%8cabr%e7%ae%97%e6%b3%95" aria-label="Dash协议和ABR算法">Dash协议和ABR算法</a><ul>
                        
                <li>
                    <a href="#dash%e5%8d%8f%e8%ae%ae%e7%ae%80%e8%bf%b0" aria-label="Dash协议简述">Dash协议简述</a></li>
                <li>
                    <a href="#abr%e7%ae%97%e6%b3%95%e7%ae%80%e4%bb%8b" aria-label="ABR算法简介">ABR算法简介</a></li></ul>
                </li>
                <li>
                    <a href="#bba0%e7%ae%97%e6%b3%95" aria-label="BBA0算法">BBA0算法</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%99%90%e9%80%9f%e6%9d%a1%e4%bb%b6%e4%b8%8b%e6%b5%8b%e8%af%95dash%e7%b3%bb%e7%bb%9f" aria-label="限速条件下测试Dash系统">限速条件下测试Dash系统</a><ul>
                        
                <li>
                    <a href="#%e5%8d%95%e4%b8%80%e9%99%90%e9%80%9f%e6%9d%a1%e4%bb%b6" aria-label="单一限速条件">单一限速条件</a><ul>
                        
                <li>
                    <a href="#%e6%97%a0%e9%99%90%e9%80%9f%e6%9d%a1%e4%bb%b6" aria-label="无限速条件">无限速条件</a></li>
                <li>
                    <a href="#%e9%99%90%e9%80%9f300kb15kb-buffer%e6%9c%80%e5%a4%a750ms%e5%bb%b6%e8%bf%9f" aria-label="限速300kb，15kb buffer，最大50ms延迟">限速300kb，15kb buffer，最大50ms延迟</a></li>
                <li>
                    <a href="#%e9%99%90%e9%80%9f800kb15kb-buffer%e6%9c%80%e5%a4%a750ms%e5%bb%b6%e8%bf%9f" aria-label="限速800kb，15kb buffer，最大50ms延迟">限速800kb，15kb buffer，最大50ms延迟</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%a8%a1%e6%8b%9f%e7%bd%91%e7%bb%9c%e6%b3%a2%e5%8a%a8%e6%83%85%e5%86%b5" aria-label="模拟网络波动情况">模拟网络波动情况</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="dash系统搭建流程">DASH系统搭建流程<a hidden class="anchor" aria-hidden="true" href="#dash系统搭建流程">#</a></h2>
<h3 id="客户端搭建">客户端搭建<a hidden class="anchor" aria-hidden="true" href="#客户端搭建">#</a></h3>
<p>首先，用git命令将<code>dash.js</code>下载到本地.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"> git clone https://github.com/Dash-Industry-Forum/dash.js.git
</span></span></code></pre></div><p>在dash.js目录下，编译运行<code>dash.js</code>.</p>
<p>{% message color:danger size: &ldquo;icon:fa-brands fa-npm&rdquo; title: %}
cd dash.js
npm install
npm run start
{% endmessage %}</p>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/17/o5gsc3hzadYOZHt.png"></p>
<p>编译完成后，会自动在浏览器页面打开dash系统的网页，点击超链接<code>here</code>进入。点击Load按钮，如果可以正常播放演示视频，说明客户端没有问题。</p>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/17/BTfnQUYNh5dqkuF.png"></p>
<h3 id="部署服务器">部署服务器<a hidden class="anchor" aria-hidden="true" href="#部署服务器">#</a></h3>
<p>使用nginx来部署HTTP服务器。由于后续服务器限速等操作在Linux系统中较为方便，将服务器部署在虚拟机上。</p>
<p>采用的操作系统版本为<code>Ubuntu 22.04.4 LTS</code>。</p>
<p>可以使用Linux apt直接安装nginx。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt-get install nginx
</span></span></code></pre></div><p>(也可以去官网下载安装包进行安装)</p>
<p>打开/nginx/conf文件夹下的nginx.conf配置文件，将配置文件内容全部替换为下面代码。这里使用8888端口对外提供下载能力。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">user</span> <span class="s">root</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">worker_processes</span>  <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">events</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">use</span> <span class="s">epoll</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">worker_connections</span> <span class="mi">204800</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">http</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">include</span>       <span class="s">mime.types</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">default_type</span>  <span class="s">application/octet-stream</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kn">sendfile</span>        <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">tcp_nopush</span>     <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kn">keepalive_timeout</span>  <span class="mi">65</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">tcp_nodelay</span>     <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">gzip</span>            <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">client_header_buffer_size</span> <span class="mi">4k</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kn">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">listen</span> <span class="mi">8888</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">server_name</span> <span class="mi">127</span><span class="s">.0.0.1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="kn">add_header</span> <span class="s">Access-Control-Allow-Origin</span> <span class="s">*</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">add_header</span> <span class="s">Access-Control-Allow-Headers</span> <span class="s">X-Requested-With</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">add_header</span> <span class="s">Access-Control-Allow-Methods</span> <span class="s">GET,POST,OPTIONS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kn">root</span> <span class="s">home/miyan/Videos</span><span class="p">;</span> <span class="kn">//这里填写所要播放的视频存放的绝对路径</span>
</span></span><span class="line"><span class="cl">            <span class="s">autoindex</span> <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>在nginx.conf所在的文件夹右键打开terminal，输入下面命令启动nginx。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nginx -p . -c ./nginx.conf 
</span></span></code></pre></div><p>如果要关闭nginx，则使用下面命令来结束进程。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pkill -9 nginx
</span></span></code></pre></div><p>(如果操作权限不够，可以使用下面命令后输入系统密码进入root模式)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">su root
</span></span></code></pre></div><h3 id="从服务器中获取视频">从服务器中获取视频<a hidden class="anchor" aria-hidden="true" href="#从服务器中获取视频">#</a></h3>
<p>首先需要关闭浏览器的缓存，保证客户端请求的视频来自服务器。</p>
<p>在客户端上方地址栏中填写URL，格式为：<code>http://服务器ip:端口号/视频的mpd文件存放在服务器的路径</code>。</p>
<p>以我的URL为例：</p>
<p><code>http://192.168.133.128:8888/Video/bbb-manifest-refresh.mpd</code></p>
<p>点击Load按钮，即可播放服务器中的视频，Show Options按钮中可以选择视频流的算法，可以通过视频下方的统计图来观察实时的视频缓冲区大小和比特率。</p>
<h2 id="实现abr算法">实现ABR算法<a hidden class="anchor" aria-hidden="true" href="#实现abr算法">#</a></h2>
<p>这里我们采用BBA0算法来实现。</p>
<h3 id="bba0算法配置">BBA0算法配置<a hidden class="anchor" aria-hidden="true" href="#bba0算法配置">#</a></h3>
<p>Dash.js的结构如下图所示：</p>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/17/GY9qWOBVEydnDMS.png"></p>
<p>配置播放器需要进入文件夹<code>dash.js/samples/dash-if-reference-player</code>。文件夹结构如下：</p>
<ul>
<li><code>dashjs_config.json</code>是播放器配置文件</li>
<li><code>index.html</code>是播放器前端页面</li>
<li><code>app/main.js</code>是页面控制逻辑实现</li>
<li><code>app/rules</code>中包括ABR算法</li>
</ul>
<p>首先在<code>app/rules</code>中添加算法文件<code>ABB0Rule.js</code>，在<code>index.html</code>中引用该文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;app/main.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;app/rules/DownloadRatioRule.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;app/rules/ThroughputRule.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">+ <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;app/rules/BBA0Rule.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>在<code>app/main.js</code>中修改规则：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">customABRRulesSelected</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">addABRCustomRule</span><span class="p">(</span><span class="s1">&#39;qualitySwitchRules&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;DownloadRatioRule&#39;</span><span class="p">,</span> <span class="nx">DownloadRatioRule</span><span class="p">);</span> <span class="cm">/* jshint ignore:line */</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">addABRCustomRule</span><span class="p">(</span><span class="s1">&#39;qualitySwitchRules&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;ThroughputRule&#39;</span><span class="p">,</span> <span class="nx">CustomThroughputRule</span><span class="p">);</span> <span class="cm">/* jshint ignore:line */</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span> <span class="c1">// $scope.player.addABRCustomRule(&#39;qualitySwitchRules&#39;,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="s1">&#39;DownloadRatioRule&#39;</span><span class="p">,</span> <span class="nx">DownloadRatioRule</span><span class="p">);</span> <span class="cm">/* jshint ignore:line */</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span> <span class="c1">// $scope.player.addABRCustomRule(&#39;qualitySwitchRules&#39;,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="s1">&#39;ThroughputRule&#39;</span><span class="p">,</span> <span class="nx">CustomThroughputRule</span><span class="p">);</span> <span class="cm">/* jshint ignore:line */</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">addABRCustomRule</span><span class="p">(</span><span class="s1">&#39;qualitySwitchRules&#39;</span><span class="p">,</span> <span class="s1">&#39;BBA0Rule&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nx">CustomBBA0Rule</span><span class="p">);</span> <span class="cm">/* jshint ignore:line */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">removeABRCustomRule</span><span class="p">(</span><span class="s1">&#39;DownloadRatioRule&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">removeABRCustomRule</span><span class="p">(</span><span class="s1">&#39;ThroughputRule&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span> <span class="c1">// $scope.player.removeABRCustomRule(&#39;DownloadRatioRule&#39;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">+</span> <span class="c1">// $scope.player.removeABRCustomRule(&#39;ThroughputRule&#39;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">+</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">removeABRCustomRule</span><span class="p">(</span><span class="s1">&#39;BBA0Rule&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>修改配置文件<code>dashjs_config.json</code>来修改buffer大小，使得更适应实验环境。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;streaming&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;buffer&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;stableBufferTime&#34;</span><span class="p">:</span> <span class="mi">24</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;bufferTimeAtTopQuality&#34;</span><span class="p">:</span> <span class="mi">24</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;bufferTimeAtTopQualityLongForm&#34;</span><span class="p">:</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;debug&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;logLevel&#34;</span><span class="p">:</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="dash协议和abr算法">Dash协议和ABR算法<a hidden class="anchor" aria-hidden="true" href="#dash协议和abr算法">#</a></h3>
<p>在解释BBA0算法原理之前，先来了解一下视频流式传播的原理。</p>
<p>区别于之前将整个视频缓存到本地再播放的技术，流式传输允许一边下载一边播放。所采取的方法是将视频和音频切割成一小段一小段的视频，每个视频包含几秒钟的内容。客户端会在本地维护一个缓冲区buffer，每次播放到T时刻后，会请求后续[T,T+k]时间段内的视频块，然后保存在本地的buffer里，这样就可以实现边下边播。</p>
<p>在现实生活中，不同客户端面临的网络状况不同，因此服务器需要准备不同码率的视频块，以根据网络情况，动态调整传输的视频质量。</p>
<h4 id="dash协议简述">Dash协议简述<a hidden class="anchor" aria-hidden="true" href="#dash协议简述">#</a></h4>
<p>Dash (Dynamic Adaptive Streaming over HTTP)协议是一种自适应动态选择传输码率的传输协议。Dash要求服务器准备不同码率和分辨率的视频切片和MPD文件，视频传输时，首先请求MPD文件并进行解析。之后，客户端会根据网络情况，buffer水平等信息对后续视频码率的请求进行动态调整。下图很好地描述了Dash系统的工作原理。</p>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/17/CFiPWyfUkSLAJT1.png"></p>
<p>其中的MPD文件包含了视频切片列表，以及每个切片的描述信息（包括码率、分辨率等）。文件结构如下图所示：</p>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/17/JyVz3Fear46vOZB.png"></p>
<h4 id="abr算法简介">ABR算法简介<a hidden class="anchor" aria-hidden="true" href="#abr算法简介">#</a></h4>
<p>ABR算法（自适应码率调节算法）的目的是让用户有更好的观看视频体验。ABR算法的评价标准为用户体验质量 (QoD, Quality of Experience)，包括高视频质量、低卡顿时间、少质量切换、低启动延迟等。</p>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/17/XzC26O1vjs7JPDo.png"></p>
<h3 id="bba0算法">BBA0算法<a hidden class="anchor" aria-hidden="true" href="#bba0算法">#</a></h3>
<p>BBA0算法的js实现代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="cm">/*global dashjs*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">CustomBBA0Rule</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">CustomBBA0RuleClass</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">factory</span> <span class="o">=</span> <span class="nx">dashjs</span><span class="p">.</span><span class="nx">FactoryMaker</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">SwitchRequest</span> <span class="o">=</span> <span class="nx">factory</span><span class="p">.</span><span class="nx">getClassFactoryByName</span><span class="p">(</span><span class="s1">&#39;SwitchRequest&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">DashMetrics</span> <span class="o">=</span> <span class="nx">factory</span><span class="p">.</span><span class="nx">getSingletonFactoryByName</span><span class="p">(</span><span class="s1">&#39;DashMetrics&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">Debug</span> <span class="o">=</span> <span class="nx">factory</span><span class="p">.</span><span class="nx">getSingletonFactoryByName</span><span class="p">(</span><span class="s1">&#39;Debug&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">context</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">instance</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">logger</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">reservoir</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">cushion</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">ratePrev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nx">setup</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">logger</span> <span class="o">=</span> <span class="nx">Debug</span><span class="p">(</span><span class="nx">context</span><span class="p">).</span><span class="nx">getInstance</span><span class="p">().</span><span class="nx">getLogger</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nx">getMaxIndex</span><span class="p">(</span><span class="nx">rulesContext</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">mediaInfo</span> <span class="o">=</span> <span class="nx">rulesContext</span><span class="p">.</span><span class="nx">getMediaInfo</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">mediaType</span> <span class="o">=</span> <span class="nx">mediaInfo</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">mediaType</span> <span class="o">!=</span> <span class="s2">&#34;video&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">SwitchRequest</span><span class="p">(</span><span class="nx">context</span><span class="p">).</span><span class="nx">create</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">abrController</span> <span class="o">=</span> <span class="nx">rulesContext</span><span class="p">.</span><span class="nx">getAbrController</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">dashMetrics</span> <span class="o">=</span> <span class="nx">DashMetrics</span><span class="p">(</span><span class="nx">context</span><span class="p">).</span><span class="nx">getInstance</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">rateMap</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">bitrateList</span> <span class="o">=</span> <span class="nx">abrController</span><span class="p">.</span><span class="nx">getBitrateList</span><span class="p">(</span><span class="nx">mediaInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">bitrateInfo</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">                                <span class="k">return</span> <span class="nx">bitrateInfo</span><span class="p">.</span><span class="nx">bitrate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                            <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">bitrateCnt</span> <span class="o">=</span> <span class="nx">bitrateList</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">step</span> <span class="o">=</span> <span class="nx">cushion</span> <span class="o">/</span> <span class="p">(</span><span class="nx">bitrateCnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">bitrateCnt</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">rateMap</span><span class="p">[</span><span class="nx">reservoir</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">*</span> <span class="nx">step</span><span class="p">]</span> <span class="o">=</span> <span class="nx">bitrateList</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">rateMin</span> <span class="o">=</span> <span class="nx">bitrateList</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">rateMax</span> <span class="o">=</span> <span class="nx">bitrateList</span><span class="p">[</span><span class="nx">bitrateCnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ratePrev</span> <span class="o">=</span> <span class="nx">ratePrev</span> <span class="o">&gt;</span> <span class="nx">rateMin</span> <span class="o">?</span> <span class="nx">ratePrev</span> <span class="o">:</span> <span class="nx">rateMin</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">ratePlus</span> <span class="o">=</span> <span class="nx">rateMax</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">rateMinus</span> <span class="o">=</span> <span class="nx">rateMin</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">ratePrev</span> <span class="o">===</span> <span class="nx">rateMax</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">ratePlus</span> <span class="o">=</span> <span class="nx">rateMax</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">bitrateCnt</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">bitrateList</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nx">ratePrev</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">ratePlus</span> <span class="o">=</span> <span class="nx">bitrateList</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">ratePrev</span> <span class="o">===</span> <span class="nx">rateMin</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">rateMinus</span> <span class="o">=</span> <span class="nx">rateMin</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">bitrateCnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">bitrateList</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nx">ratePrev</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">rateMinus</span> <span class="o">=</span> <span class="nx">bitrateList</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">currentBufferLevel</span> <span class="o">=</span> <span class="nx">dashMetrics</span><span class="p">.</span><span class="nx">getCurrentBufferLevel</span><span class="p">(</span><span class="nx">mediaType</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">func</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bufferLevel</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">bufferLevel</span> <span class="o">&lt;</span> <span class="nx">reservoir</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nx">rateMap</span><span class="p">[</span><span class="nx">cushion</span> <span class="o">+</span> <span class="nx">reservoir</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">bufferLevel</span> <span class="o">&gt;</span> <span class="nx">cushion</span> <span class="o">+</span> <span class="nx">reservoir</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nx">rateMap</span><span class="p">[</span><span class="nx">reservoir</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kd">let</span> <span class="nx">index</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">((</span><span class="nx">bufferLevel</span> <span class="o">-</span> <span class="nx">reservoir</span><span class="p">)</span> <span class="o">/</span> <span class="nx">step</span><span class="p">)</span> <span class="o">*</span><span class="nx">step</span> <span class="o">+</span> <span class="nx">reservoir</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nx">rateMap</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">fBufferLevel</span> <span class="o">=</span> <span class="nx">func</span><span class="p">(</span><span class="nx">currentBufferLevel</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">rateNext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nx">currentBufferLevel</span> <span class="o">&lt;=</span> <span class="nx">reservoir</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">rateNext</span> <span class="o">=</span> <span class="nx">rateMin</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">currentBufferLevel</span> <span class="o">&gt;=</span> <span class="nx">cushion</span> <span class="o">+</span> <span class="nx">reservoir</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">rateNext</span> <span class="o">=</span> <span class="nx">rateMax</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">fBufferLevel</span> <span class="o">&gt;=</span> <span class="nx">ratePlus</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">bitrateCnt</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">bitrateList</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nx">fBufferLevel</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">rateNext</span> <span class="o">=</span> <span class="nx">bitrateList</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">fBufferLevel</span> <span class="o">&lt;=</span> <span class="nx">rateMinus</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">bitrateCnt</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">bitrateList</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nx">fBufferLevel</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">rateNext</span> <span class="o">=</span> <span class="nx">bitrateList</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">rateNext</span> <span class="o">=</span> <span class="nx">ratePrev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">quality</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">bitrateCnt</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">bitrateList</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="nx">rateNext</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">quality</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">&#34;[BBA0Rule] CurrentBufferLevel = &#34;</span> <span class="o">+</span> <span class="nx">currentBufferLevel</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">&#34;[BBA0Rule] Bitrate list = &#34;</span> <span class="o">+</span> <span class="nx">bitrateList</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">&#34;[BBA0Rule] Previous bitrate = &#34;</span> <span class="o">+</span> <span class="nx">ratePrev</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">&#34;[BBA0Rule] Next bitrate = &#34;</span> <span class="o">+</span> <span class="nx">rateNext</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">&#34;[BBA0Rule] Quality = &#34;</span> <span class="o">+</span> <span class="nx">quality</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">ratePrev</span> <span class="o">=</span> <span class="nx">rateNext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">SwitchRequest</span><span class="p">(</span><span class="nx">context</span><span class="p">).</span><span class="nx">create</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nx">quality</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">CustomBBA0RuleClass</span><span class="p">.</span><span class="nx">__dashjs_factory_name</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nx">SwitchRequest</span><span class="p">.</span><span class="nx">PRIORITY</span><span class="p">.</span><span class="nx">STRONG</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">instance</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">getMaxIndex</span><span class="o">:</span> <span class="nx">getMaxIndex</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">setup</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">instance</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">CustomBBA0RuleClass</span><span class="p">.</span><span class="nx">__dashjs_factory_name</span> <span class="o">=</span> <span class="s1">&#39;CustomBBA0Rule&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">CustomBBA0Rule</span> <span class="o">=</span> <span class="nx">dashjs</span><span class="p">.</span><span class="nx">FactoryMaker</span><span class="p">.</span><span class="nx">getClassFactory</span><span class="p">(</span><span class="nx">CustomBBA0RuleClass</span><span class="p">);</span>
</span></span></code></pre></div><p>这段代码实现了一个自定义的基于缓冲区的自适应比特率调整规则，称为 BBA0Rule。下面是算法的基本原理和解释：</p>
<ol>
<li>
<p><strong>缓冲区分级</strong>：</p>
<ul>
<li>规则将缓冲区分为两个区间：reservoir 和 cushion。Reservoir 是一个较小的缓冲区域，cushion 是一个较大的缓冲区域。</li>
<li>如果当前缓冲区低于 reservoir，则会选择最高比特率。</li>
<li>如果当前缓冲区高于 cushion + reservoir，则会选择最低比特率。</li>
<li>在两个区间之间，根据当前缓冲区的位置，线性地分配比特率。</li>
</ul>
</li>
<li>
<p><strong>比特率调整</strong>：</p>
<ul>
<li><strong>如果当前缓冲区低于 reservoir，选择最高比特率。</strong></li>
<li><strong>如果当前缓冲区高于 cushion + reservoir，选择最低比特率。</strong></li>
<li><strong>如果当前缓冲区在两个区间之间，则根据当前缓冲区的位置线性地调整比特率。</strong>
<ul>
<li><strong>计算当前缓冲区在两个区间之间的相对位置</strong>： 首先，算法计算当前缓冲区水平相对于 reservoir 的位置，即当前缓冲区水平减去 reservoir。然后，它将这个相对位置除以 cushion 减去 reservoir，得到一个介于 0 到 1 之间的值，表示当前缓冲区在两个区间之间的相对位置。</li>
<li><strong>线性插值</strong>： 然后，算法使用这个相对位置来进行线性插值。它将相对位置乘以 bitrateList 中相邻比特率的差异，然后加上 reservoir 对应的比特率。这样就得到了一个介于最小和最大比特率之间的插值比特率，这个插值比特率取决于当前缓冲区的水平。</li>
<li><strong>选择比特率</strong>： 最后，根据线性插值得到的比特率，算法将其作为下一个选择的比特率。这个插值比特率在两个区间之间提供了一个平滑的过渡，使得在缓冲区水平变化时，比特率的调整更加连续和平稳。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>变量</strong>：</p>
<ul>
<li>reservoir：较小的缓冲区域大小。</li>
<li>cushion：较大的缓冲区域大小。</li>
<li>ratePrev：上一个选择的比特率。</li>
<li>rateMap：用于存储不同缓冲区水平下的比特率。</li>
</ul>
</li>
<li>
<p><strong>实现细节</strong>：</p>
<ul>
<li>规则通过获取媒体信息、ABR 控制器和 Dash 指标等来执行决策。</li>
<li>通过调整当前缓冲区水平来选择适当的比特率。</li>
<li>记录每次的选择，以便下一次选择时使用。</li>
</ul>
</li>
<li>
<p><strong>日志输出</strong>：</p>
<ul>
<li>在选择比特率时输出相关的日志信息，包括当前缓冲区水平、比特率列表、上一个选择的比特率、下一个选择的比特率和选择的质量等信息。</li>
</ul>
</li>
</ol>
<p>这种规则的核心思想是根据当前缓冲区的状态来调整比特率，以平衡视频质量和播放的连续性。Buffer水平与视频速率的关系如下图所示。</p>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/17/mxpOSrTaE5Lu1sl.png"></p>
<h2 id="限速条件下测试dash系统">限速条件下测试Dash系统<a hidden class="anchor" aria-hidden="true" href="#限速条件下测试dash系统">#</a></h2>
<p>linux系统自带的tc命令可以对网络带宽进行限制。</p>
<p>首先可以执行下面命令来获取网卡名称：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ifconfig
</span></span></code></pre></div><p><img loading="lazy" src="https://s2.loli.net/2024/04/17/J8nimLHuQtwWge9.png"></p>
<p>其中，<code>ens33</code>即为网卡名称，下面的<code>192.168.133.128</code>为主机ip地址。</p>
<p>执行下面的命令可以为网卡限制带宽：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">tc qdisc add dev ens33 root tbf rate 500Kbit latency 50ms burst 15kb
</span></span><span class="line"><span class="cl"><span class="c1">#将eth0网卡限速到500Kbit/s，15bk的buffer，TBF最多产生50ms的延迟</span>
</span></span><span class="line"><span class="cl"><span class="c1">#tbf是Token Bucket Filter的简写，适合于把流速降低到某个值</span>
</span></span></code></pre></div><p>执行下面命令可以取消限制：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">tc qdisc del dev ens33 root
</span></span></code></pre></div><h3 id="单一限速条件">单一限速条件<a hidden class="anchor" aria-hidden="true" href="#单一限速条件">#</a></h3>
<h4 id="无限速条件">无限速条件<a hidden class="anchor" aria-hidden="true" href="#无限速条件">#</a></h4>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/17/iTd21IRCqal8W3r.png"></p>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/17/JeXqKjBQf5wI1P2.png"></p>
<p>可以看到缓冲区大小稳定的上下波动，视频播放为最高质量，说明此时网络较为稳定且网速较快，可以完成“边下边播”的任务。</p>
<h4 id="限速300kb15kb-buffer最大50ms延迟">限速300kb，15kb buffer，最大50ms延迟<a hidden class="anchor" aria-hidden="true" href="#限速300kb15kb-buffer最大50ms延迟">#</a></h4>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/17/ZoOamzHiuwC6BdE.png"></p>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/17/XTAtGYPdfnWOKp5.png"></p>
<p>此时网速较慢，视频很卡顿。视频质量和buffer水平都很低。</p>
<h4 id="限速800kb15kb-buffer最大50ms延迟">限速800kb，15kb buffer，最大50ms延迟<a hidden class="anchor" aria-hidden="true" href="#限速800kb15kb-buffer最大50ms延迟">#</a></h4>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/17/eLi2WuoRj6HFIzx.png"></p>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/17/EBDTvmlN17wCHUI.png"></p>
<p>此时视频质量和buffer水平较300kb时均有上升，但视频质量仍然一般。</p>
<h3 id="模拟网络波动情况">模拟网络波动情况<a hidden class="anchor" aria-hidden="true" href="#模拟网络波动情况">#</a></h3>
<p>在服务器端运行该python文件，来控制网速不断发生变化。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">#控制带宽随时间变化</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tpt</span> <span class="o">=</span> <span class="p">[</span><span class="mi">300</span><span class="p">,</span><span class="mi">500</span><span class="p">,</span><span class="mi">700</span><span class="p">,</span><span class="mi">900</span><span class="p">,</span><span class="mi">1200</span><span class="p">,</span><span class="mi">1800</span><span class="p">,</span><span class="mi">2000</span><span class="p">,</span><span class="mi">1500</span><span class="p">,</span><span class="mi">1200</span><span class="p">,</span><span class="mi">900</span><span class="p">,</span><span class="mi">700</span><span class="p">,</span><span class="mi">500</span><span class="p">,</span><span class="mi">300</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tpt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&#34;sudo tc qdisc add dev eth0 root tbf rate </span><span class="si">{}</span><span class="s2">kbit latency 50ms burst 15kb&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&#34;sudo tc qdisc del dev eth0 root&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>buffer水平和视频码率变化如下图所示：</p>
<p><img loading="lazy" src="https://s2.loli.net/2024/04/17/IRl8cosVtg5r7hN.png"></p>
<p>可以看出，当buffer水平升高时，会导致视频切换到更高的码率；buffer水平下降时，会让视频切换到更低的码率。同时buffer也在不断的消耗和补充。</p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://m1yan.github.io/tags/%E5%A4%A7%E4%BD%9C%E4%B8%9A/">大作业</a></li>
      <li><a href="https://m1yan.github.io/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://m1yan.github.io/posts/diffusers-tutorials/">
    <span class="title">« 上一页</span>
    <br>
    <span>Diffusers Tutorials</span>
  </a>
  <a class="next" href="https://m1yan.github.io/posts/2023%E5%B9%B4%E7%BB%88%E6%8A%A5%E5%91%8A/">
    <span class="title">下一页 »</span>
    <br>
    <span>2023年终总结</span>
  </a>
</nav>

  </footer><script src="https://giscus.app/client.js"
        data-repo="M1YAN/M1YAN.github.io"
        data-repo-id="R_kgDOLdlkMA"
        data-category="Announcements"
        data-category-id="DIC_kwDOLdlkMM4Ck7BX"
        data-mapping="url"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="light"
        data-lang="zh-CN"
        crossorigin="anonymous"
        async>
</script>
</article>
    </main>
    
<footer class="footer">
        <span>© <a href="https://github.com/adityatelange/hugo-PaperMod/graphs/contributors">PaperMod Contributors</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>
<script src="https://immmmm.com/waterfall.min.js"></script>
<script src="https://immmmm.com/imgStatus.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    
    var photosAll = document.getElementsByTagName('gallery') || '';
    if(photosAll){
      for(var i=0;i < photosAll.length;i++){
        photosAll[i].innerHTML = '<div class="gallery-photos">'+photosAll[i].innerHTML+'</div>'
        var photosIMG = photosAll[i].getElementsByTagName('img')
        for(var j=0;j < photosIMG.length;j++){
          wrap(photosIMG[j], document.createElement('div'));
        }
      }
    }
    function wrap(el, wrapper) {
      wrapper.className = "gallery-photo";
      el.parentNode.insertBefore(wrapper, el);
      wrapper.appendChild(el);
    }
    
    let galleryPhotos = document.querySelectorAll('.gallery-photos') || ''
    if(galleryPhotos){
      imgStatus.watch('.gallery-photo img', function(imgs) {
        if(imgs.isDone()){
          for(var i=0;i < galleryPhotos.length;i++){
            waterfall(galleryPhotos[i]);
            let pagePhoto = galleryPhotos[i].querySelectorAll('.gallery-photo');
            for(var j=0;j < pagePhoto.length;j++){pagePhoto[j].className += " visible"};
          }
        }
      });
      window.addEventListener('resize', function () {
        for(var i=0;i < galleryPhotos.length;i++){
          waterfall(galleryPhotos[i]);
        }
      });
    }
  });
</script>
<script type="text/javascript" src="https://immmmm.com/view-image.js"></script>
<script>
  window.ViewImage && ViewImage.init('.gallery-photo img')
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
